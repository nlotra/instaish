<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="img/favicon.ico">

    <title>Instaish</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">

    <!--[if lt IE 9]>
      <script src="js/html5shiv.js"></script>
      <script src="js/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div id="default-gram" style="display:none;">
      
    </div>
    <ul id="grams" style="display:none;"></ul>
    <div class="flippers">

    </div>
    <script src="js/jquery-1.10.2.min.js"></script>
    <script src="js/jquery.flippy.min.js"></script>
    <script src="js/instafeed.min.js"></script>

    <!-- https://github.com/keithamus/jwerty -->
    <script src="js/jwerty.js"></script>

    <!-- https://github.com/kayahr/jquery-fullscreen-plugin -->
    <script src="js/jquery.fullscreen-min.js"></script>

    <script type="text/javascript">

      var per_row = 6;
      var tag = "immediaZA"

      var wrapper = $('.flippers'),
        box_width = Math.floor( wrapper.width() / per_row ),
        width = box_width * per_row;
        width_margin = wrapper.width() - width;
        height = Math.floor( ( wrapper.height() / box_width ) ) * box_width,
        height_margin = wrapper.height() - height;
        per_column = height / box_width,
        flippers = per_row  * per_column,
        html = '';

      for(var i = $(".flippers").length; i <= flippers; i++) {
        html += '<div class="flipper"><div class="flip" id="flip_' + i + '"></div></div>'; 
      }
      wrapper.html('<div class="inner">' + html + '</div>');

      $('.inner', wrapper ).css({
        'width' : width,
        'height' : height,
        'margin-top': height_margin / 2,
        'margin-bottom': height_margin / 2,
        'margin-left': width_margin / 2,
        'margin-right': width_margin / 2
      });

      $('.flipper, .flipper > div', wrapper ).css({
          'width': box_width,
          'height': box_width
      });

      function preloadImage(url) {
        var img=new Image();
        img.src=url;
      }

      $( document ).ready(function() {

        function gramulate() {
          var feed = new Instafeed({
              get: 'tagged',
              tagName: tag,
              clientId: '2506a522329a496bbacd16ea45a582d9',
              resolution: 'low_resolution',
              limit: 60,
              success : function(object) {
                if(object.data){
                  object.data.forEach(function(gram) {
                    if( $('#gram_' + gram.id).length < 1 ) {
                      $('#grams').prepend('<li class="gram" id="gram_' + gram.id + '"><img src="' + gram.images.low_resolution.url + '" class="img-responsive" /></li>');
                    }
                    preloadImage( gram.images.low_resolution.url );
                  });
                }
              }
          });
          feed.run();
        };

        gramulate();

        window.setInterval(function(){

          var random = 0;
          while( random == 0){
            // Pick a random element.
            random = Math.floor( Math.random() * ( flippers - 1 + 1 ) + 1 )

            // If all elements have an href then everything has been flipped at least once, continue with randomness.
            if( $(".flip[href]").length == flippers ) {
              break;
            }
            // If the element has already been flipped, choose another random.
            if(typeof $("#flip_" + random).attr('href') !== 'undefined' && $("#flip_" + random).attr('href') !== false) {
              random = 0;
            }
          }
          var flip = $( "#flip_" + random )

          flip.flippy({
            onStart: function(){
              var grams = $(".gram").length;
              var seen = $(".gram[href]").length;
              var unseen = grams - seen;
              
              if( unseen < 5) {
                gramulate();
              }
            },
            direction: 'RIGHT',
            duration: '300',
            depth: 0.30,
            verso: function() {
              var content = "";

              // Loop hrough grams and find the first unseen and set the flip content.
              $('.gram:not([href])').each(function() {
                content = $(this).html();
                $(this).attr( 'href', flip.attr('id') );
                flip.attr( 'href', $(this).attr('id') );
                return false;
              });

              // If the flip content is still not set, loop again and find any gram currently not on screen.
              if( content == "" ){
                $('.gram').each(function() {
                  if( $( '.flip[href="' + $(this).attr('id') + '"]' ).length < 1 ) {
                    content = $(this).html();
                    $(this).attr( 'href', flip.attr('id') );
                    flip.attr( 'href', $(this).attr('id') );
                    
                    // Move to the bottom of the list
                    $(this).appendTo('#grams');

                    return false;
                  }
                });
              }

              // If content is still blank, set default.
              if( content == "" ){
                content = $('#default-gram').html();
                $(this).attr( 'href', "#" );
                flip.attr( 'href', "#" );
              }

              return content;
            }
          });
        }, 5000);

      });
    </script>
  </body>
</html>

